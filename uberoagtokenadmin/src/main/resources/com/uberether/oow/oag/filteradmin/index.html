<html>
    <head>
        <title>OAG Token Manager</title>

        <link rel="stylesheet" href="slick.grid.css" type="text/css"/>
        <link rel="stylesheet" href="css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/>
        <link rel="stylesheet" href="examples.css" type="text/css"/>
        <link rel="stylesheet" href="controls/slick.columnpicker.css" type="text/css"/>

        <script src="lib/jquery-1.7.min.js"></script>
        <script src="lib/jquery-ui-1.8.16.custom.min.js"></script>
        <script src="lib/jquery.event.drag-2.0.min.js"></script>
        <script src="slick.core.js"></script>
        <script src="plugins/slick.checkboxselectcolumn.js"></script>
        <script src="plugins/slick.autotooltips.js"></script>
        <script src="plugins/slick.cellrangedecorator.js"></script>
        <script src="plugins/slick.cellrangeselector.js"></script>
        <script src="plugins/slick.cellcopymanager.js"></script>
        <script src="plugins/slick.cellselectionmodel.js"></script>
        <script src="plugins/slick.rowselectionmodel.js"></script>
        <script src="controls/slick.columnpicker.js"></script>
        <script src="slick.formatters.js"></script>
        <script src="slick.editors.js"></script>
        <script src="slick.dataview.js"></script>
        <script src="slick.grid.js"></script>        
        
        <style>
            html, body {
                margin: 0;
                padding: 0;
                background-color: White;
                overflow: auto;
            }

            body {
                font: 11px Helvetica, Arial, sans-serif;
            }
            
            #pgHeader {
                margin-left: 4px;
                margin-top: 4px;
            }
            
            #pgHeader img {
                margin-right: 4px;
                vertical-align: middle;
            }
            
            #title {
                font-size: 250%;
                font-weight: bold;
            }

            #container {
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            .slick-cell-checkboxsel {
                background: #f0f0f0;
                border-right-color: silver;
                border-right-style: solid;
            }
        </style>
    </head>
    <body>
        <div id="pgHeader">
            <img src="uberether.png" />
            <span id="title">OAG Token Manager</span>
            &nbsp;
            <button id="refreshButton">Refresh</button>
            &nbsp;
            <button id="revokeButton">Revoke Selected</button>
            &nbsp;
            <button id="revokeAllButton">Revoke All</button>
            &nbsp;
            <input id="filterText" type="text" />
        </div>
        <div id="container"></div>

        <script>
            $(function () {
                var grid,
                    checkboxSelector = new Slick.CheckboxSelectColumn({
                        cssClass: "slick-cell-checkboxsel"
                    }),
                    columns = [
                        checkboxSelector.getColumnDefinition(),
                        {id: "ID", name: "ID", field: "id", width: 120, sortable: true},
                        {id: "Client ID", name: "Client ID", field: "clientId", width: 120, sortable: true},
                        {id: "Expires", name: "Expires", field: "expiryTimeString", width: 120, sortable: true},
                        {id: "Browser", name: "Browser", field: "browser", width: 120, sortable: true},
                        {id: "Ver", name: "Ver", field: "browserVer", width: 120, sortable: true},
                        {id: "Platform", name: "Platform", field: "platform", width: 120, sortable: true},
                        {id: "User Auth", name: "User Auth", field: "userAuth", width: 120, sortable: true},
                        {id: "User Name", name: "User Name", field: "userName", width: 120, sortable: true} 
                    ],
                    options = {
                        enableColumnReorder: false,
                        enableCellNavigation: true,
                        editable: true,
                        asyncEditorLoading: false,
                        autoEdit: false
                    };

                var filterString = "";

                var dataView = new Slick.Data.DataView();
                dataView.onRowCountChanged.subscribe(function (e, args) {
                  grid.updateRowCount();
                  grid.render();
                });

                dataView.onRowsChanged.subscribe(function (e, args) {
                  grid.invalidateRows(args.rows);
                  grid.render();
                });
                dataView.beginUpdate();
                dataView.setFilter(function(item) {
                    if (filterString === "") {
                        return true;
                    }
                    return item.clientId.indexOf(databaseId) !== -1 ||
                           item.clientId.indexOf(clientId) !== -1 ||
                           item.clientId.indexOf(expiryTimeString) !== -1 ||
                           item.clientId.indexOf(browser) !== -1 ||
                           item.clientId.indexOf(browserVer) !== -1 ||
                           item.clientId.indexOf(platform) !== -1 ||
                           item.clientId.indexOf(userAuth) !== -1 ||
                           item.clientId.indexOf(userName) !== -1;
                });
                dataView.endUpdate();            

                function refreshGrid() {
                    grid.invalidateAllRows();
                    grid.render();
                }

                function reloadData() {
                    $.getJSON("../tokens", function(data) {
                        dataView.setItems(data);
                        refreshGrid();
                    });
                }

                grid = new Slick.Grid("#container", dataView, columns, options);
                grid.setSelectionModel(new Slick.RowSelectionModel({selectActiveRow: false}));
                grid.registerPlugin(checkboxSelector);
                var columnpicker = new Slick.Controls.ColumnPicker(columns, grid, options);
                // @todo Filter control of some sort
                // @todo Scroll bars?

                grid.onSort.subscribe(function (e, args) {
                    var sortField = args.sortCol.field;
                    dataView.sort(function(dataRow1, dataRow2) {
                            var value1 = dataRow1[sortField], value2 = dataRow2[sortField];
                            var result = (value1 === value2) ?  0 :
                                       ((value1 > value2 ? 1 : -1));
                            return result;
                        }, args.sortAsc);
                });
                reloadData();

                var $filterText = $("#filterText");
                $("#refreshButton").click(function() {
                    filterString = "";
                    $filterText.value="";
                    reloadData();
                });
                $("#revokeButton").click(function() {
                    alert("B");
                });
                $("#revokeAllButton").click(function() {
                    alert("C");
                });
                $filterText.on("change keydown paste input", function() {
                    var newVal = $filterText.value;
                    if (newVal !== filterString) {
                        filterString = $filterText.value;
                        refreshGrid();
                    }
                });
            });         
        </script>
    </body>
</html>