<html>
    <head>
        <title>OAG Token Manager</title>

        <link rel="stylesheet" href="slick.grid.css" type="text/css"/>
        <link rel="stylesheet" href="css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/>
        <link rel="stylesheet" href="examples.css" type="text/css"/>
        <link rel="stylesheet" href="controls/slick.columnpicker.css" type="text/css"/>

        <script src="lib/jquery-1.7.min.js"></script>
        <script src="lib/jquery-ui-1.8.16.custom.min.js"></script>
        <script src="lib/jquery.event.drag-2.0.min.js"></script>
        <script src="slick.core.js"></script>
        <script src="plugins/slick.checkboxselectcolumn.js"></script>
        <script src="plugins/slick.autotooltips.js"></script>
        <script src="plugins/slick.cellrangedecorator.js"></script>
        <script src="plugins/slick.cellrangeselector.js"></script>
        <script src="plugins/slick.cellcopymanager.js"></script>
        <script src="plugins/slick.cellselectionmodel.js"></script>
        <script src="plugins/slick.rowselectionmodel.js"></script>
        <script src="controls/slick.columnpicker.js"></script>
        <script src="slick.formatters.js"></script>
        <script src="slick.editors.js"></script>
        <script src="slick.dataview.js"></script>
        <script src="slick.grid.js"></script>        
        
        <style>
            html, body {
                margin: 0;
                padding: 0;
                background-color: White;
                overflow: auto;
            }

            body {
                font: 11px Helvetica, Arial, sans-serif;
            }
            
            #pgHeader {
                margin-left: 4px;
                margin-top: 4px;
            }
            
            #pgHeader img {
                margin-right: 4px;
                vertical-align: middle;
            }
            
            #title {
                font-size: 250%;
                font-weight: bold;
            }

            #container {
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            .slick-cell-checkboxsel {
                background: #f0f0f0;
                border-right-color: silver;
                border-right-style: solid;
            }
        </style>
    </head>
    <body>
        <div id="pgHeader">
            <img src="uberether.png" />
            <span id="title">OAG Token Manager</span>
            &nbsp;
            <button id="refreshButton">Refresh</button>
            &nbsp;
            <button id="revokeSelectedButton">Revoke Selected</button>
            &nbsp;
            <button id="revokeAllButton">Revoke All</button>
            &nbsp;
            Filter: <input id="filterText" type="text" /> <button id="clearFilterButton">Clear Filter</button>
        </div>
        <div id="container"></div>

        <script>
            $(function () {
                var grid,
                    checkboxSelector = new Slick.CheckboxSelectColumn({
                        cssClass: "slick-cell-checkboxsel"
                    }),
                    columns = [
                        checkboxSelector.getColumnDefinition(),
                        {id: "ID", name: "ID", field: "id", width: 120, sortable: true},
                        {id: "Client ID", name: "Client ID", field: "clientId", width: 120, sortable: true},
                        {id: "Expires", name: "Expires", field: "expiryTimeString", width: 120, sortable: true},
                        {id: "Browser", name: "Browser", field: "browser", width: 120, sortable: true},
                        {id: "Ver", name: "Ver", field: "browserVer", width: 120, sortable: true},
                        {id: "Platform", name: "Platform", field: "platform", width: 120, sortable: true},
                        {id: "User Auth", name: "User Auth", field: "userAuth", width: 120, sortable: true},
                        {id: "User Name", name: "User Name", field: "userName", width: 120, sortable: true} 
                    ],
                    options = {
                        enableColumnReorder: false,
                        enableCellNavigation: true,
                        editable: true,
                        asyncEditorLoading: false,
                        autoEdit: false
                    },
                    $filterText = $("#filterText"),
                    filterString = "",
                    dataView = new Slick.Data.DataView(),
                    $refreshButton = $("#refreshButton");
                    
                dataView.onRowCountChanged.subscribe(function (e, args) {
                  grid.updateRowCount();
                  grid.render();
                });
                dataView.onRowsChanged.subscribe(function (e, args) {
                  grid.invalidateRows(args.rows);
                  grid.render();
                });
                dataView.beginUpdate();
                dataView.setFilter(function(item) {
                    if (filterString === "") {
                        return true;
                    }
                    
                    return item.id.indexOf(filterString) !== -1 ||
                           item.clientId.indexOf(filterString) !== -1 ||
                           item.expiryTimeString.indexOf(filterString) !== -1 ||
                           item.browser.indexOf(filterString) !== -1 ||
                           item.browserVer.indexOf(filterString) !== -1 ||
                           item.platform.indexOf(filterString) !== -1 ||
                           item.userAuth.indexOf(filterString) !== -1 ||
                           item.userName.indexOf(filterString) !== -1;
                });
                dataView.endUpdate();            

                grid = new Slick.Grid("#container", dataView, columns, options);
                grid.setSelectionModel(new Slick.RowSelectionModel({selectActiveRow: false}));
                grid.registerPlugin(checkboxSelector);
                var columnpicker = new Slick.Controls.ColumnPicker(columns, grid, options);

                grid.onSort.subscribe(function (e, args) {
                    var sortField = args.sortCol.field;
                    dataView.sort(function(dataRow1, dataRow2) {
                            var value1 = dataRow1[sortField], value2 = dataRow2[sortField];
                            var result = (value1 === value2) ?  0 :
                                       ((value1 > value2 ? 1 : -1));
                            return result;
                        }, args.sortAsc);
                });


                function revokeTokens(ids) {
                    $.ajax("../revoke", { 
                        data: JSON.stringify(ids), 
                        contentType: "application/json", 
                        type: "POST",
                        cache: false
                    }).done(function(data, textStatus, jqXHR) {
                        $refreshButton.click();
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        alert("Failed to revoke tokens: "+textStatus+"\n\n"+errorThrown);
                        $refreshButton.click();
                    });
                }
               
                $refreshButton.click(function() {
                    $.ajax("../tokens", { 
                        contentType: "application/json", 
                        type: "GET",
                        cache: false
                    }).done(function(data, textStatus, jqXHR) {
                        filterString = "";
                        $filterText.val("");
                        grid.setSelectedRows([]);
                        dataView.beginUpdate();
                        dataView.setItems(data);
                        dataView.endUpdate();
                        grid.invalidate();
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        alert("Failed to refresh: "+textStatus+"\n\n"+errorThrown);
                    });
                });
                $("#revokeSelectedButton").click(function() {
                    var ids = [];
                    var selectedRows = grid.getSelectedRows();
                    for (var i = selectedRows.length-1; i >= 0; i--) {
                        var item = grid.getDataItem(selectedRows[i]);
                        if (item) {
                            ids.push(item.id);
                        }
                    }
                    
                    revokeTokens(ids);
                });
                $("#revokeAllButton").click(function() {
                    var ids = [];
                    for (var i = dataView.getLength() - 1; i >= 0; i--) {
                        var item = dataView.getItem(i);
                        if (item) {
                            ids.push(item.id);
                        }
                    }
                    
                    revokeTokens(ids);
                });
                $("#clearFilterButton").click(function(){
                    filterString = "";
                    $filterText.val("");
                    dataView.beginUpdate();
                    dataView.refresh();
                    dataView.endUpdate();
                })
                $filterText.on("change keydown paste input", function() {
                    var newVal = $filterText.val();
                    if (newVal !== filterString) {
                        filterString = newVal;
                        dataView.beginUpdate();
                        dataView.refresh();
                        dataView.endUpdate();
                    }
                });
                
                $refreshButton.click();            
            });         
        </script>
    </body>
</html>